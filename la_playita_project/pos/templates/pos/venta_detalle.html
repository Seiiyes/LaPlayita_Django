{% extends "core/base.html" %}

{% block title %}Venta #{{ venta.id }} - La Playita{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <!-- Información de la Venta -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0"><i class="bi bi-receipt me-2"></i>Venta #{{ venta.id }}</h4>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Fecha:</strong> {{ venta.fecha_venta|date:"d/m/Y H:i" }}</p>
                            <p><strong>Usuario:</strong> {{ venta.usuario.get_full_name|default:venta.usuario.username }}</p>
                            <p><strong>Método de Pago:</strong>
                                {% if pago %}
                                    {{ pago.metodo_pago|title }}
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Canal de Venta:</strong> {{ venta.canal_venta|title }}</p>
                            {% if venta.cliente %}
                                <p><strong>Cliente:</strong> {{ venta.cliente.nombres }} {{ venta.cliente.apellidos }}</p>
                            {% else %}
                                <p><strong>Cliente:</strong> <span class="text-muted">Sin registrar</span></p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detalles de la Venta -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Detalle de Productos</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Producto</th>
                                    <th>Lote</th>
                                    <th class="text-end">Cantidad</th>
                                    <th class="text-end">Precio Unitario</th>
                                    <th class="text-end">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for detalle in detalles %}
                                    <tr>
                                        <td>
                                            <strong>{{ detalle.producto.nombre }}</strong>
                                            <br>
                                            <small class="text-muted">{{ detalle.producto.categoria.nombre }}</small>
                                        </td>
                                        <td>{{ detalle.lote.numero_lote }}</td>
                                        <td class="text-end">{{ detalle.cantidad }}</td>
                                        <td class="text-end">${{ detalle.producto.precio_unitario|floatformat:2 }}</td>
                                        <td class="text-end fw-bold">${{ detalle.subtotal|floatformat:2 }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resumen de Pago -->
        <div class="col-md-4">
            <div class="card shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-calculator me-2"></i>Resumen de Pago</h5>
                </div>
                <div class="card-body">
                    {% with subtotal=venta.total_venta|add:"0" %}
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span>${{ subtotal|floatformat:2 }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>Impuestos (19%):</span>
                            <span>${{ impuesto|floatformat:2 }}</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between fw-bold fs-5 mb-3 p-3 bg-light rounded">
                            <span>Total a Pagar:</span>
                            <span>${{ venta.total_venta|floatformat:2 }}</span>
                        </div>
                    {% endwith %}

                    <hr>
                    
                    <div class="d-grid gap-2">
                        <a href="{% url 'pos:pos_view' %}" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-2"></i>Nueva Venta
                        </a>
                        <a href="{% url 'pos:listar_ventas' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-list-check me-2"></i>Ver Historial
                        </a>
                        <button onclick="window.print()" class="btn btn-outline-info">
                            <i class="bi bi-printer me-2"></i>Imprimir
                        </button>

                       {% if venta.cliente and venta.cliente.nombres != "Consumidor" and venta.cliente.apellidos != "Final" %}
    <a id="btn-enviar-factura" href="{% url 'pos:enviar_factura' venta.id %}" class="btn btn-warning">
        <i class="bi bi-envelope-fill me-2"></i>Enviar por Correo
    </a>
{% endif %}



                        <!-- BOTÓN DE DESCARGA DE FACTURA PDF -->
                        <a href="{% url 'pos:descargar_factura' venta.id %}" class="btn btn-success">
                            <i class="bi bi-download me-2"></i>Descargar Factura
                        </a>
                        <!-- FIN BOTÓN -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="toast-confirm" class="toast align-items-center text-bg-success border-0 position-fixed top-0 end-0 m-3" role="alert" aria-live="assertive" aria-atomic="true" style="z-index: 9999; display:none;">
  <div class="d-flex">
    <div class="toast-body">
      <i class="bi bi-check-circle-fill me-2"></i> ¡Factura enviada correctamente!
    </div>
    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
  </div>
</div>
<script>
document.getElementById('btn-enviar-factura').addEventListener('click', function(e) {
    e.preventDefault();
    fetch(this.href)
        .then(response => response.json())
        .then(data => {
            if(data.success){
                var toastEl = document.getElementById('toast-confirm');
                toastEl.style.display = 'block';
                setTimeout(function() {
                  toastEl.style.display = 'none';
                }, 3500);
            } else {
                alert('Error: ' + data.error);
            }
        });
});
</script>

{% endblock %}
